;eraIM@Sから導入しました(eramaou)


;=================================================
;媚藥中毒関連の関數群
;=================================================
;-------------------------------------------------
;媚藥中毒の発病と回復
;-------------------------------------------------
@APHRODISIAC_ADDICT
;體內媚藥殘留度を7日ごとに1減らす
IF (DAY + 1) % 7 == 0
	IF CFLAG:31 > 0
		CFLAG:31 -= 1
		SIF CFLAG:31 < 0
			CFLAG:31 = 0
	ENDIF
			
	;[媚藥中毒]の場合は禁斷癥狀チェックも行う
	IF TALENT:46
	    IF  CFLAG:1 != 9
		    IF CFLAG:32
			   CFLAG:32 = 0
		    ELSE
			   CALL PRECIPITATE_WITHDRAWAL
			ENDIF   
		ENDIF
	ENDIF
ENDIF

;【媚藥中毒】の消失判定
;體內媚藥殘留度が0になれば[媚藥中毒]消失
IF CFLAG:31 == 0 && TALENT:46
	PRINTFORML %SAVESTR:TARGET%的樣子變了……
	PRINTFORML 體內的媚藥效果被根除，%SAVESTR:TARGET%的藥癮消失了。
	PRINTFORML %SAVESTR:TARGET%的【%TALENTNAME:46%】消除了。
	WAIT
	TALENT:46 = 0
ENDIF
;【媚藥中毒】の取得判定
;[容易上癮]がなければ體內媚藥殘留度が12以上、あれば9以上で[媚藥中毒]取得
IF ((TALENT:86 == 0 && CFLAG:31 >= 12) || (TALENT:72 && CFLAG:31 >= 9)) && TALENT:46 == 0
	PRINTFORML %SAVESTR:TARGET%的樣子有點奇怪……
	PRINTFORML 媚藥的過量使用，令%SAVESTR:TARGET%沾上藥癮了。
	PRINTFORML %SAVESTR:TARGET%獲得了【%TALENTNAME:46%】。
	WAIT
	TALENT:46 = 1
	;中毒になりたてということで、ボーナスとして體內媚藥殘留度を一律15以上に（おめでとう！）
	SIF CFLAG:31 < 15
		CFLAG:31 = 15
ENDIF
;【瘋狂】の取得判定
;[容易上癮]がなければ體內媚藥殘留度が40以上、あれば30以上で[瘋狂]取得
IF (CFLAG:31 >= 40 || (TALENT:72 && CFLAG:31 >= 30)) && TALENT:123 == 0
	PRINTFORML %SAVESTR:TARGET%的樣子有點奇怪……
	PRINTFORML %SAVESTR:TARGET%隨著媚藥的過量使用，人也變得暴躁了。
	PRINTFORML %SAVESTR:TARGET%獲得了【%TALENTNAME:123%】。
	PRINTL 
	TALENT:123 = 1
ENDIF
;【廃人】の取得判定
;[容易上癮]がなければ體內媚藥殘留度が100以上、あれば75以上で[崩壞]取得
IF (CFLAG:31 >= 100 || (TALENT:72 && CFLAG:31 >= 75)) && TALENT:9 == 0
	PRINTFORML %SAVESTR:TARGET%的樣子有點奇怪……
	PRINTFORML %SAVESTR:TARGET%隨著媚藥的過量使用，完全變成了廢人。
	PRINTFORML %SAVESTR:TARGET%的精神變成【%TALENTNAME:9%】了。
	PRINTL 
	TALENT:9 = 1
ENDIF
;-------------------------------------------------
;禁斷癥狀イベント
;-------------------------------------------------
@PRECIPITATE_WITHDRAWAL
;U=[治療][獻身的]持ちによる禁斷癥狀緩和効果
;V=禁斷癥狀の酷さ
;W=ステータス悪化の內容(＆ステータス悪化が生じたか否か)
U = 0
V = 0
W = 0
PRINTFORML %SAVESTR:TARGET%在訴說著自己的身體不適應癥狀。
PRINTL 看來，春藥中毒的禁斷癥狀出現了……
WAIT

IF ITEM:26
	$INPUT_LOOP_01
	PRINTFORML 給予%SAVESTR:TARGET%媚藥嗎？
	PRINTL  [0] - 好的
	PRINTL  [1] - 不要
	INPUT
	IF RESULT == 0
		IF CFLAG:1 == 2
			PRINTFORML %SAVESTR:TARGET%爲了獲得媚藥，誘惑著魔王軍上下人眾。
			PRINTFORMW 流下了貪慾的口水，完全忘記了作為勇者的使命。
			PRINTFORML %SAVESTR:TARGET%陷落了。
			CFLAG:1 = 0
			MONEY += 100 * CFLAG:9
			EX_FLAG:4444 += 100 * CFLAG:9
			PRINTFORMW 獲得{100 * CFLAG:9}G！
			CFLAG:506 = 1
			CFLAG:507 = 0
			
			CALL PARTY_DEL, TARGET
		ENDIF
		PRINTFORML %SAVESTR:TARGET%搶過了裝著濃縮媚藥的瓶子，
		PRINTFORML 馬上如飢似渴地一飲而盡，放心地嘆了一口氣。
		WAIT
		CFLAG:31 += 1
		ITEM:26 -= 1
		RETURN 0
	ELSEIF RESULT != 1
		GOTO INPUT_LOOP_01
	ENDIF	
ENDIF

IF CFLAG:1 == 2
	PRINTFORML 數小時後%SAVESTR:TARGET%身體的顫抖終於停了下來。
	;體力が減る
	BASE:0 -= 300
	SIF BASE:0 < 1
		BASE:0 = 1
	RETURN 0
ENDIF


;[治療][獻身的]持ちの人數をカウント
;ただし待機中のみカウント
REPEAT CHARANUM
	SIF TALENT:COUNT:117 && CFLAG:COUNT:1 == 0
		U += 1
	SIF TALENT:COUNT:63 && CFLAG:COUNT:1 == 0
		U += 1
REND

;體內媚藥殘留度と[治療][獻身的]持ちによる禁斷癥狀緩和効果に応じてチェック回數決定
V = (CFLAG:31 / 10) + 1 - U
IF V < 1
	V = 1
ELSEIF V > 10
	V = 10
ENDIF

;チェック回數は最低1回～最高10回
REPEAT V
	;40%の確率でステータス悪化イベント発生
	;最高の10回チェックした場合は99.996%の確率で発生する計算
	IF RAND:100 < 40
		CALL SUFFER_FROM_WITHDRAWAL
		BREAK
	ENDIF
REND

IF W
	PRINTFORML 被禁斷癥狀折磨著的%SAVESTR:TARGET%痛苦地在地上打滾，
	PRINTL 持續數小時的癲狂的行為也終於讓她感到累了，癥狀被平息，終於老實了下來。
	PRINTL 不過，不僅是她本人，護理人員也感到筋疲力盡了……
	WAIT 
	PRINTFORML %SAVESTR:TARGET%的體力和氣力衰退了。

	;とりあえず表示はせずにこっそり減らす方向で
	MAXBASE:0 -= 50
	SIF BASE:0 > MAXBASE:0
		BASE:0 = MAXBASE:0
	;最大體力は600まで下がる（それ以下にはならない）
	SIF MAXBASE:0 < 600
		MAXBASE:0 = 600
	
	MAXBASE:1 -= 50
	SIF BASE:1 > MAXBASE:1
		BASE:1 = MAXBASE:1
	;最大気力は100まで下がる（それ以下にはならない）
	SIF MAXBASE:1 < 100
		MAXBASE:1 = 100
	
	BASE:0 -= 500
	SIF BASE:0 < 1
		BASE:0 = 1

	;看病していた人もぐったりします
	;ただし待機中のみ看病します
	REPEAT CHARANUM
		;[治療][獻身的]持ちは確実に看病している
		IF (TALENT:COUNT:117 || TALENT:COUNT:63) && CFLAG:COUNT:1 == 0
			BASE:COUNT:0 -= 200
			SIF BASE:COUNT:0 < 1
				BASE:COUNT:0 = 1
		;そうでない場合でも1/3の確率で看病に當たっている
		ELSEIF RAND:3 == 0 && CFLAG:COUNT:1 == 0
			BASE:COUNT:0 -= 200
			SIF BASE:COUNT:0 < 1
				BASE:COUNT:0 = 1
		ENDIF
	REND
ELSE
	PRINTFORML 數小時後，%SAVESTR:TARGET%身體的顫抖終於停止了，
	PRINTL 護理人員也辛苦了，
	PRINTL 這次總算平安度過了……
	WAIT
	;でも體力は減る
	BASE:0 -= 300
	SIF BASE:0 < 1
		BASE:0 = 1

	;看病していた人もぐったりします
	REPEAT CHARANUM
		;[治療][獻身的]持ちは確実に看病している
		IF TALENT:COUNT:117 || TALENT:COUNT:63
			BASE:COUNT:0 -= 100
			SIF BASE:COUNT:0 < 1
				BASE:COUNT:0 = 1
		;そうでない場合でも1/3の確率で看病に當たっている
		ELSEIF RAND:3 == 0
			BASE:COUNT:0 -= 100
			SIF BASE:COUNT:0 < 1
				BASE:COUNT:0 = 1
		ENDIF
	REND
ENDIF
PRINTL 

@SUFFER_FROM_WITHDRAWAL
W = RAND:50 - V + (U * 2)

IF W < 5
	IF TALENT:9 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_WRECK
	ELSEIF TALENT:123 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_CRAZY
	ELSEIF RELATION:0 == 0 || RELATION:0 > 50
		CALL PRECIPITATE_WITHDRAWAL_BE_A_MISANTHROPIST
	ELSEIF TALENT:34 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_RESISTER
	ELSEIF TALENT:26 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_DEPRESSION
	ELSEIF TALENT:22 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_ATHYMIA
	ELSE
		CALL PRECIPITATE_WITHDRAWAL_FALL_INTO_DISFAVOR
	ENDIF
ELSEIF W < 10
	IF TALENT:123 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_CRAZY
	ELSEIF RELATION:0 == 0 || RELATION:0 > 50
		CALL PRECIPITATE_WITHDRAWAL_BE_A_MISANTHROPIST
	ELSEIF TALENT:34 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_RESISTER
	ELSEIF TALENT:26 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_DEPRESSION
	ELSEIF TALENT:22 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_ATHYMIA
	ELSE
		CALL PRECIPITATE_WITHDRAWAL_FALL_INTO_DISFAVOR
	ENDIF
ELSEIF W < 15
	IF TALENT:34 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_RESISTER
	ELSEIF TALENT:26 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_DEPRESSION
	ELSEIF TALENT:22 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_ATHYMIA
	ELSE
		CALL PRECIPITATE_WITHDRAWAL_FALL_INTO_DISFAVOR
	ENDIF
ELSEIF W < 20
	IF TALENT:34 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_RESISTER
	ELSEIF TALENT:26 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_DEPRESSION
	ELSEIF TALENT:22 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_ATHYMIA
	ELSE
		CALL PRECIPITATE_WITHDRAWAL_FALL_INTO_DISFAVOR
	ENDIF
ELSEIF W < 25
	IF TALENT:26 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_DEPRESSION
	ELSEIF TALENT:22 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_ATHYMIA
	ELSE
		CALL PRECIPITATE_WITHDRAWAL_FALL_INTO_DISFAVOR
	ENDIF
ELSEIF W < 30
	IF TALENT:22 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_ATHYMIA
	ELSE
		CALL PRECIPITATE_WITHDRAWAL_FALL_INTO_DISFAVOR
	ENDIF
ELSE
	PRINTL 
ENDIF
PRINTL 

W = 1


@PRECIPITATE_WITHDRAWAL_FALL_INTO_DISFAVOR
PRINTFORMW %SAVESTR:TARGET%的樣子明顯不對頭……
PRINTFORMW %SAVESTR:TARGET%飽受禁斷癥狀的痛苦，被%CALLNAME:MASTER%嫌棄了。
;こっそり好感度をマイナス
CFLAG:2 -= 200

@PRECIPITATE_WITHDRAWAL_BE_A_ATHYMIA
PRINTFORMW %SAVESTR:TARGET%的樣子明顯不對頭……
PRINTFORMW %SAVESTR:TARGET%飽受禁斷癥狀的痛苦，連感情都失去了。
PRINTFORMW %SAVESTR:TARGET%獲得了【感情淡薄】。
TALENT:22 = 1

@PRECIPITATE_WITHDRAWAL_BE_A_DEPRESSION
PRINTFORMW %SAVESTR:TARGET%的樣子明顯不對頭……
PRINTFORMW %SAVESTR:TARGET%飽受禁斷癥狀的痛苦，對人生看法灰暗。
PRINTFORMW %SAVESTR:TARGET%獲得了【悲觀的】。
TALENT:26 = 1

@PRECIPITATE_WITHDRAWAL_BE_A_RESISTER
PRINTFORMW %SAVESTR:TARGET%的樣子明顯不對頭……
PRINTFORMW %SAVESTR:TARGET%飽受禁斷癥狀的痛苦，變得不和善了。
PRINTFORMW %SAVESTR:TARGET%獲得了【抵抗】。
TALENT:34 = 1

@PRECIPITATE_WITHDRAWAL_BE_A_MISANTHROPIST
PRINTFORMW %SAVESTR:TARGET%的樣子明顯不對頭……
PRINTFORMW %SAVESTR:TARGET%飽受禁斷癥狀的痛苦，被%CALLNAME:MASTER%嫌棄了。
IF RELATION:0 == 0
	RELATION:0 = 50
ELSE
	RELATION:0 -= 50
	SIF RELATION:0 < 30
		RELATION:0 = 30
ENDIF
;こっそり好感度もマイナス
CFLAG:2 -= 200

@PRECIPITATE_WITHDRAWAL_BE_A_CRAZY
PRINTFORMW %SAVESTR:TARGET%的樣子明顯不對頭……
PRINTFORMW %SAVESTR:TARGET%飽受禁斷癥狀的痛苦，充滿攻擊性了。
PRINTFORMW %SAVESTR:TARGET%獲得了【瘋狂】。
TALENT:123 = 1

@PRECIPITATE_WITHDRAWAL_BE_A_WRECK
PRINTFORMW %SAVESTR:TARGET%的樣子明顯不對頭……
PRINTFORMW %SAVESTR:TARGET%飽受禁斷癥狀的痛苦，完全變成一個廢人了。
PRINTFORMW %SAVESTR:TARGET%的精神【崩壞】了……
TALENT:19 = 1

